{% extends "base.njk" %}
{% block content %}
    <style>
        .subtitle {
            font-size: 0.875rem;
            font-weight: 700;
            letter-spacing: 0.1em;
            display: block;
            margin-bottom: 1rem;
        }
        .form-container {
            background-color: white;
            border-radius: 1rem;
            padding: 3rem;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
        }
        .sidebar-element {
            background-color: white;
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 1.5rem;
            text-align: center;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
        }
        .sidebar-element i {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            display: block;
        }
        .sidebar-element strong {
            display: block;
            margin-bottom: 0.75rem;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .sidebar-element p {
            font-size: 0.9rem;
            margin: 0;
            line-height: 1.6;
        }
        .summary-box {
            background-color: white;
            border-radius: 1rem;
            padding: 2rem;
            position: sticky;
            top: 80px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
        }
        .summary-box h3 {
            font-size: 1.25rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #dee2e6;
        }
        .form-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .form-control,
        .form-select {
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            font-family: 'Quattrocento', serif;
        }
        .form-control:focus,
        .form-select:focus {
            box-shadow: 0 0 0 0.25rem rgba(var(--bs-primary-rgb), 0.1);
        }
        .form-range {
            height: 0.5rem;
        }
        .range-value {
            text-align: center;
            font-weight: 700;
            margin-top: 0.75rem;
            font-size: 1.1rem;
        }
        .tos-text {
            font-size: 0.875rem;
            margin-top: 1rem;
            text-align: center;
        }
        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }
        small.text-muted {
            font-size: 0.875rem;
            color: #6c757d;
        }
        .success-message {
            text-align: center;
            padding: 3rem;
        }
        .success-message i {
            font-size: 5rem;
            margin-bottom: 1.5rem;
        }
        .success-message h2 {
            margin-bottom: 1rem;
        }
        .success-message .alert {
            border-radius: 0.75rem;
            background-color: #215c5c;
            color: #fff;
        }
        hr {
            margin: 2.5rem 0;
            opacity: 0.1;
        }
    </style>
    <link
        rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/@eonasdan/tempus-dominus@6.9.4/dist/css/tempus-dominus.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@eonasdan/tempus-dominus@6.9.4/dist/js/tempus-dominus.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@eonasdan/tempus-dominus@6.9.4/dist/js/tempus-dominus.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
    <script>
        function quoteForm() {
            return {
                // Form state
                bedrooms: 1,
                bathrooms: 1,
                sqft: 1200,
                schedule: 'One-time',
                addons: [],
                conditions: {
                    smoke: false,
                    pets: false,
                    moveInOut: false,
                    fragileItems: false
                },
                selectedDate: null,
                selectedTime: null,
                // Pricing
                PRICING: null,
                calculateQuote: null,
                quote: null,
                loading: false,
                submitting: false,
                submitted: false,
                error: null,
                // Computed properties
                get preferredDateTime() {
                    if (!this.selectedDate || !this.selectedTime) 
                        return null;
                    
                    return new Date(
                        this.selectedDate.getFullYear(), this.selectedDate.getMonth(), this.selectedDate.getDate(), this.selectedTime.getHours(), this.selectedTime.getMinutes()
                    ).toISOString().slice(0, 16);
                },
                get isRushBooking() {
                    if (!this.selectedDate) 
                        return false;
                    
                    const diffDays = (this.selectedDate - new Date()) / (1000 * 60 * 60 * 24);
                    return diffDays <= 7;
                },
                get disqualified() {
                    return this.conditions.smoke;
                },
                // Initialization
                async init() {
                    await this.loadPricing();
                    this.initializeDatePickers();
                    this.recalculate();
                    this.$watch('bedrooms', () => this.recalculate());
                    this.$watch('bathrooms', () => this.recalculate());
                    this.$watch('sqft', () => this.recalculate());
                    this.$watch('schedule', () => this.recalculate());
                    this.$watch('addons', () => this.recalculate());
                    this.$watch('conditions', () => this.recalculate());
                },
                async loadPricing() {
                    try {
                        const res = await fetch('http://localhost:5173/api/public-pricing');
                        if (! res.ok) 
                            throw new Error('Failed to fetch pricing');
                        
                        const data = await res.json();
                        this.PRICING = data.PRICING;
                        this.calculateQuote = new Function('PRICING', 'args', `
                        ${
                            data.calculateQuote
                        }
                        return calculateQuote(args);
                    `);
                    } catch (err) {
                        console.error('Error loading pricing:', err);
                    }
                },
                initializeDatePickers() {
                    this.$nextTick(() => { // Date picker
                        new tempusDominus.TempusDominus(this.$refs.datePickerContainer, {
                            display: {
                                viewMode: 'calendar',
                                components: {
                                    date: true,
                                    hours: false,
                                    minutes: false,
                                    seconds: false
                                },
                                buttons: {
                                    today: true,
                                    close: true
                                }
                            },
                            restrictions: {
                                minDate: new Date()
                            },
                            localization: {
                                format: 'MM/dd/yyyy'
                            }
                        });
                        // Time picker
                        new tempusDominus.TempusDominus(this.$refs.timePickerContainer, {
                            display: {
                                viewMode: 'clock',
                                components: {
                                    date: false,
                                    hours: true,
                                    minutes: true,
                                    seconds: false
                                },
                                buttons: {
                                    close: true
                                }
                            },
                            stepping: 30,
                            localization: {
                                hourCycle: 'h12',
                                format: 'hh:mm T'
                            }
                        });
                        // Date changes trigger recalculation (rush fee check)
                        this
                            .$refs
                            .datePickerContainer
                            .addEventListener('change.td', (e) => {
                                if (e.detail.date) {
                                    this.selectedDate = e.detail.date;
                                    this.recalculate(); // Explicitly recalculate on date change
                                }
                            });
                        // Time changes only update state, no recalculation
                        this
                            .$refs
                            .timePickerContainer
                            .addEventListener('change.td', (e) => {
                                if (e.detail.date) {
                                    this.selectedTime = e.detail.date;
                                }
                            });
                    });
                },
                // Quote calculation
                recalculate() {
                    if (!this.calculateQuote || this.disqualified) {
                        this.quote = null;
                        return;
                    }
                    this.loading = true;
                    try {
                        const result = this.calculateQuote(this.PRICING, {
                            property: {
                                bedrooms: this.bedrooms,
                                bathrooms: this.bathrooms,
                                sqft: this.sqft,
                                accessDifficulty: 4814194
                            },
                            addOns: Object.fromEntries(Object.keys(this.PRICING.addOns).map(key => [key, this.addons.includes(key)])),
                            conditions: {
                                urgentTimeline: this.isRushBooking,
                                pets: this.conditions.pets,
                                moveInOut: this.conditions.moveInOut,
                                fragileItems: this.conditions.fragileItems
                            },
                            schedule: this.schedule
                        });
                        this.quote = {
                            price: result.recurringTotal,
                            lineItems: [
                                {
                                    label: 'Base Price',
                                    amount: result.basePrice
                                },
                                {
                                    label: 'Bathroom Charge',
                                    amount: result.bathroomCharge
                                },
                                {
                                    label: 'Add-Ons',
                                    amount: result.addOnsTotal
                                },
                                {
                                    label: 'Condition Fees',
                                    amount: result.conditionFeesTotal
                                }, {
                                    label: 'Access Fee',
                                    amount: result.accessFee
                                }
                            ]
                        };
                    } catch (err) {
                        console.error('Error calculating quote:', err);
                        this.quote = null;
                    } finally {
                        this.loading = false;
                    }
                },
                async handleSubmit(event) {
                    event.preventDefault();
                    this.submitting = true;
                    this.error = null;
                    try {
                        const formData = new FormData(event.target);
                        // Your API call here
                        const response = await fetch('/api/bookings', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(
                                {
                                    customer: {
                                        firstName: formData.get('firstName'),
                                        lastName: formData.get('lastName'),
                                        email: formData.get('email'),
                                        phone: formData.get('phone'),
                                        smsConsent: formData.get('smsConsent') === 'on'
                                    },
                                    // ... rest of your data
                                }
                            )
                        });
                        if (! response.ok) 
                            throw new Error('Failed to submit booking');
                        
                        const result = await response.json();
                        this.submitted = true;
                    } catch (err) {
                        console.error('Submission error:', err);
                        this.error = err.message || 'Please try again or contact us directly.';
                    } finally {
                        this.submitting = false;
                    }
                },
                // Labels
                bedroomLabel() {
                    if (this.bedrooms === 0) 
                        return 'No Bedrooms';
                    
                    if (this.bedrooms === 1) 
                        return '1 Bedroom';
                    
                    if (this.bedrooms >= 6) 
                        return '6+ Bedrooms';
                    
                    return `${
                        this.bedrooms
                    } Bedrooms`;
                },
                bathroomLabel() {
                    if (this.bathrooms === 1) 
                        return '1 Bathroom';
                    
                    if (this.bathrooms >= 6) 
                        return '6+ Bathrooms';
                    
                    return `${
                        this.bathrooms
                    } Bathrooms`;
                },
                sqftLabel() {
                    return `About ${
                        this.sqft.toLocaleString()
                    } sqft`;
                }
            };
        }
    </script>
    <main x-data="quoteForm()" x-init="init()">
        <section class="section">
            <div class="container">
                <div class="row">
                    <div class="col-lg-8">
                        <div class="form-container">
                            <div class="text-center mb-5" id="form-header">
                                <span class="subtitle">Get Started</span>
                                <h2 class="mb-4">Book Your Home Cleaning Online</h2>
                                <h5 class="text-muted fw-normal mb-4">
                                    Get an instant quote and secure your spot in minutes!
                                </h5>
                                <p class="text-muted">
                                    We can't wait to help you get your time back! Fill out the form below to see your personalized quote. Once you're happy
                                    with the details, you can book and pay your deposit right away to lock in your preferred date. Your cleaning is just a
                                    few clicks away!
                                </p>
                            </div>
                            <hr/>
                            <form
                                id="cleaningEstimateForm" @submit="handleSubmit" novalidate>
                                <!-- Personal Info -->
                                <div class="row g-3 mb-4">
                                    <div class="col-md-6">
                                        <label for="firstName" class="form-label">First Name
                                            <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" id="firstName" name="firstName" required placeholder="Enter your first name"/>
                                        <div class="invalid-feedback">
                                            Please enter your first name.
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="lastName" class="form-label">Last Name
                                            <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" id="lastName" name="lastName" required placeholder="Enter your last name"/>
                                        <div class="invalid-feedback">
                                            Please enter your last name.
                                        </div>
                                    </div>
                                </div>
                                <div class="row g-3 mb-4">
                                    <div class="col-md-6">
                                        <label for="email" class="form-label">Email
                                            <span class="text-danger">*</span>
                                        </label>
                                        <input type="email" class="form-control" id="email" name="email" required placeholder="Enter your email"/>
                                        <div class="invalid-feedback">
                                            Please enter a valid email.
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="phone" class="form-label">Phone Number</label>
                                        <input
                                            type="tel"
                                            class="form-control"
                                            id="phone"
                                            name="phone"
                                            placeholder="Enter your phone number"
                                            pattern="[0-9\s\-\(\)\+\.]{10,20}"/>
                                        <div class="invalid-feedback">
                                            Please enter a valid phone number.
                                        </div>
                                    </div>
                                    <div class="form-check mb-4 col-md-12">
                                        <input class="form-check-input" type="checkbox" id="smsConsent" name="smsConsent"/>
                                        <label class="form-check-label" for="smsConsent">
                                            I consent to receive SMS related to this booking
                                            <span class="text-danger">*</span>
                                        </label>
                                    </div>
                                </div>
                                <!-- Service Address -->
                                <h3 class="form-section-title">Service Address</h3>
                                <div class="mb-4">
                                    <label for="address1" class="form-label">Address where we'll be cleaning</label>
                                    <input type="text" class="form-control" id="address1" name="address1" placeholder="Street address"/>
                                </div>
                                <div class="mb-4">
                                    <label for="address2" class="form-label">Apt/Unit #</label>
                                    <input type="text" class="form-control" id="address2" name="address2" placeholder="Apt, suite, unit, etc. (optional)"/>
                                </div>
                                <div class="row g-3 mb-4">
                                    <div class="col-md-5">
                                        <label for="city" class="form-label">City / Town</label>
                                        <input type="text" class="form-control" id="city" name="city" placeholder="City"/>
                                    </div>
                                    <div class="col-md-3">
                                        <label for="state" class="form-label">State / Region</label>
                                        <input type="text" class="form-control" id="state" name="state" placeholder="State"/>
                                    </div>
                                    <div class="col-md-4">
                                        <label for="zipcode" class="form-label">ZIP / Postal Code</label>
                                        <input type="text" class="form-control" id="zipcode" name="zipcode" placeholder="ZIP code"/>
                                    </div>
                                </div>
                                <!-- Property Details -->
                                <h3 class="form-section-title">Property Details</h3>
                                <div class="mb-4">
                                    <label for="bedrooms" class="form-label d-flex align-items-center gap-2">
                                        <i class="bi bi-door-closed"></i>
                                        How many bedrooms should be cleaned?
                                    </label>
                                    <input
                                        x-model.number="bedrooms"
                                        type="range"
                                        class="form-range"
                                        id="bedrooms"
                                        name="bedrooms"
                                        min="0"
                                        max="6"
                                        step="1"/>
                                    <div class="range-value" x-text="bedroomLabel()"></div>
                                </div>
                                <div class="mb-4">
                                    <label for="bathrooms" class="form-label d-flex align-items-center gap-2">
                                        <i class="bi bi-droplet"></i>
                                        How many bathrooms should be cleaned?
                                    </label>
                                    <input
                                        x-model.number="bathrooms"
                                        type="range"
                                        class="form-range"
                                        id="bathrooms"
                                        name="bathrooms"
                                        min="1"
                                        max="6"
                                        step="0.5"/>
                                    <div class="range-value" x-text="bathroomLabel()"></div>
                                    <small class="text-muted d-block mt-2">Count bathrooms with only a toilet and sink as a half bathroom</small>
                                </div>
                                <div class="mb-4">
                                    <label for="sqft" class="form-label d-flex align-items-center gap-2">
                                        <i class="bi bi-arrows-angle-expand"></i>
                                        How large is the property?
                                    </label>
                                    <input x-model.number="sqft" type="range" class="form-range" id="sqft" name="sqft" min="300" max="10000" step="100"/>
                                    <div class="range-value" x-text="sqftLabel()"></div>
                                </div>
                                <!-- Cleaning Schedule -->
                                <div class="mb-4">
                                    <label class="form-label">Choose your cleaning schedule</label>
                                    <div class="row g-2">
                                        <template x-for="option in ['One-time','Weekly','Bi-weekly','Monthly']" :key="option">
                                            <div class="col-6 col-md-3">
                                                <input type="radio" class="btn-check" x-model="schedule" :id="option" :value="option" autocomplete="off"/>
                                                <label class="btn w-100" :for="option" x-text="option"></label>
                                            </div>
                                        </template>
                                    </div>
                                </div>
                                <!-- Add-ons -->
                                <section class="mb-4">
                                    <h3 class="text-xl font-semibold mb-0">Add-On Services</h3>
                                    <p class="text-muted mb-2">Check all that apply</p>
                                    <template x-if="PRICING">
                                        <template x-for="[key, addon] in Object.entries(PRICING.addOns)" :key="key">
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input" x-model="addons" :value="key" :id="'addon-' + key"/>
                                                <label class="form-check-label" :for="'addon-' + key" x-text="`${addon.label} (+$${addon.price.toFixed(2)})`"></label>
                                            </div>
                                        </template>
                                    </template>
                                </section>
                                <!-- Date/Time -->
                                <section class="mb-4">
                                    <h3 class="mb-3">Preferred Cleaning Date & Time</h3>
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Date</label>
                                            <div class="input-group" x-ref="datePickerContainer" data-td-target-input="nearest" data-td-target-toggle="nearest">
                                                <input type="text" class="form-control" data-td-target="#datePicker" placeholder="Select date..." readonly required/>
                                                <span class="input-group-text" data-td-target="#datePicker" data-td-toggle="datetimepicker">
                                                    <i class="bi bi-calendar-event"></i>
                                                </span>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Time</label>
                                            <div class="input-group" x-ref="timePickerContainer" data-td-target-input="nearest" data-td-target-toggle="nearest">
                                                <input type="text" class="form-control" data-td-target="#timePicker" placeholder="Select time..." readonly required/>
                                                <span class="input-group-text" data-td-target="#timePicker" data-td-toggle="datetimepicker">
                                                    <i class="bi bi-clock"></i>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    <div x-show="isRushBooking" class="alert alert-info mt-3" x-transition>
                                        <small>
                                            <strong>Rush Fee Applied:</strong>
                                            Your selected date is within 7 days (+$75.00)</small>
                                    </div>
                                </section>
                                <!-- Home Conditions -->
                                <section class="space-y-3 mb-4">
                                    <h3 class="text-xl font-semibold">Home Conditions</h3>
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" x-model="conditions.smoke" id="condition-smoke"/>
                                        <label class="form-check-label" for="condition-smoke">
                                            Smoke / pests / mold
                                        </label>
                                    </div>
                                    <div x-show="conditions.smoke" class="text-danger text-sm mt-2" x-transition>
                                        We cannot accept bookings for properties with smoke, pests, or mold issues.
                                    </div>
                                    <template x-if="PRICING">
                                        <template
                                            x-for="[key, condition] in Object.entries(PRICING.conditionFees).filter(([k]) => k !== 'urgentTimeline')"
                                            :key="key">
                                            <div class="form-check">
                                                <input type="checkbox" class="form-check-input" x-model="conditions[key]" :id="'condition-' + key"/>
                                                <label x-text="`${condition.label} (+$${condition.price.toFixed(2)})`" class="form-check-label" :for="'condition-'+key"></label>
                                            </div>
                                        </template>
                                    </template>
                                </section>
                            </form>
                            <!-- Success Message -->
                            <div id="successMessage" class="success-message" style="display: none">
                                <i class="bi bi-check-circle-fill"></i>
                                <h2>Estimate request successfully sent!</h2>
                                <p class="lead mb-4">
                                    Thank you for submitting a request for your FREE cleaning estimate! We will be in contact shortly to discuss your
                                    estimate.
                                </p>
                                <div class="alert alert-warning mb-0">
                                    <strong>IMPORTANT:</strong>
                                    Check your spam folders in the next 24 hours for our estimate so you don't miss
                                                                        it!
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Sidebar -->
                    <div class="col-lg-4 d-none d-lg-block">
                        <div class="sidebar-element">
                            <i class="bi bi-calculator"></i>
                            <strong>1. Get Your Instant Quote</strong>
                            <p>Tell us about your home and see your personalized price in real-time.</p>
                        </div>
                        <div class="sidebar-element">
                            <i class="bi bi-calendar-check"></i>
                            <strong>2. Choose Your Date & Book</strong>
                            <p>Pick your preferred cleaning date and securely pay your deposit online.</p>
                        </div>
                        <div class="sidebar-element">
                            <i class="bi bi-stars"></i>
                            <strong>3. Relax & Let Us Clean!</strong>
                            <p>We'll take care of everything, giving you time to focus on what matters most.</p>
                        </div>
                        <div class="summary-box">
                            <h3>Your Cleaning Summary</h3>
                            <div x-show="disqualified" class="alert alert-danger">
                                We cannot accept bookings for properties with smoke, pests, or mold.
                            </div>
                            <div x-show="loading" class="text-muted">Calculating estimateâ€¦</div>
                            <template x-if="quote">
                                <div>
                                    <template x-for="item in quote.lineItems" :key="item.label">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span x-text="item.label"></span>
                                            <strong x-text="`$${item.amount.toFixed(2)}`"></strong>
                                        </div>
                                    </template>
                                    <hr/>
                                    <div class="d-flex justify-content-between fs-5 mb-4">
                                        <strong>Estimated Total</strong>
                                        <strong x-text="`$${quote.price.toFixed(2)}`"></strong>
                                    </div>
                                    <!-- Success Message -->
                                    <div x-show="submitted && !error" class="alert alert-success" x-transition>
                                        <i class="bi bi-check-circle-fill me-2"></i>
                                        <strong>Estimate request sent!</strong>
                                        <p class="mb-2 mt-2">
                                            Thank you for submitting a request for your FREE cleaning estimate! We will be in contact shortly.
                                        </p>
                                        <p class="mb-0 small">
                                            <strong>IMPORTANT:</strong>
                                            Check your spam folders in the next 24 hours for our estimate!
                                        </p>
                                    </div>
                                    <!-- Error Message -->
                                    <div x-show="error" class="alert alert-danger" x-transition>
                                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                        <strong>Oops! Something went wrong.</strong>
                                        <p class="mb-0 mt-2" x-text="error"></p>
                                    </div>
                                    <!-- Submit button (hidden after successful submission) -->
                                    <div x-show="!submitted">
                                        <button type="submit" form="cleaningEstimateForm" class="btn w-100 mb-3" :disabled="disqualified || submitting">
                                            <span x-show="!submitting">Submit Estimate Request</span>
                                            <span x-show="submitting">
                                                <span class="spinner-border spinner-border-sm me-2" role="status"></span>
                                                Submitting...
                                            </span>
                                        </button>
                                        <p class="tos-text text-center small mb-0">
                                            By clicking "Submit Estimate Request" you agree to our Terms of Service
                                        </p>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                    <div class="d-lg-none position-fixed bottom-0 start-0 end-0 bg-white border-top shadow-lg p-3" style="z-index: 1000;">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <small class="text-muted d-block">Estimated Total</small>
                                <strong class="fs-4" x-show="quote" x-text="quote ? `$${quote.price.toFixed(2)}` : '-'"></strong>
                            </div>
                            <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="offcanvas" data-bs-target="#quoteSummary">
                                View Details
                            </button>
                        </div>
                        <button
                            type="submit"
                            form="cleaningEstimateForm"
                            class="btn w-100"
                            :disabled="disqualified || submitting"
                            x-show="!submitted">
                            <span x-show="!submitting">Submit Estimate Request</span>
                            <span x-show="submitting">
                                <span class="spinner-border spinner-border-sm me-2"></span>
                                Submitting...
                            </span>
                        </button>
                        <!-- Success/Error messages -->
                        <div x-show="submitted && !error" class="alert alert-success mt-2 mb-0 py-2" x-transition>
                            <small>
                                <i class="bi bi-check-circle-fill me-1"></i>
                                Request sent! Check your email.</small>
                        </div>
                        <div x-show="error" class="alert alert-danger mt-2 mb-0 py-2" x-transition>
                            <small>
                                <i class="bi bi-exclamation-triangle-fill me-1"></i>
                                <span x-text="error"></span>
                            </small>
                        </div>
                    </div>
                    <!-- Mobile offcanvas for full details -->
                    <div class="offcanvas offcanvas-bottom" tabindex="-1" id="quoteSummary" style="height: 70vh;">
                        <div class="offcanvas-header">
                            <h5 class="offcanvas-title">Your Cleaning Summary</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
                        </div>
                        <div class="offcanvas-body">
                            <div x-show="disqualified" class="alert alert-danger">
                                We cannot accept bookings for properties with smoke, pests, or mold.
                            </div>
                            <template x-if="quote">
                                <div>
                                    <template x-for="item in quote.lineItems" :key="item.label">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span x-text="item.label"></span>
                                            <strong x-text="`$${item.amount.toFixed(2)}`"></strong>
                                        </div>
                                    </template>
                                    <hr/>
                                    <div class="d-flex justify-content-between fs-5">
                                        <strong>Estimated Total</strong>
                                        <strong x-text="`$${quote.price.toFixed(2)}`"></strong>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
{% endblock %}