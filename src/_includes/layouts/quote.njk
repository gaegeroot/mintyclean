{% extends "base.njk" %}
{% block content %}
    <style>
        .subtitle {
            font-size: 0.875rem;
            font-weight: 700;
            letter-spacing: 0.1em;
            display: block;
            margin-bottom: 1rem;
        }
        .form-container {
            background-color: white;
            border-radius: 1rem;
            padding: 3rem;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
        }
        .sidebar-element {
            background-color: white;
            border-radius: 1rem;
            padding: 2rem;
            margin-bottom: 1.5rem;
            text-align: center;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
        }
        .sidebar-element i {
            font-size: 2.5rem;
            margin-bottom: 1rem;
            display: block;
        }
        .sidebar-element strong {
            display: block;
            margin-bottom: 0.75rem;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .sidebar-element p {
            font-size: 0.9rem;
            margin: 0;
            line-height: 1.6;
        }
        .summary-box {
            background-color: white;
            border-radius: 1rem;
            padding: 2rem;
            position: sticky;
            top: 80px;
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
        }
        .summary-box h3 {
            font-size: 1.25rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #dee2e6;
        }
        .form-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .form-control,
        .form-select {
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            font-family: 'Quattrocento', serif;
        }
        .form-control:focus,
        .form-select:focus {
            box-shadow: 0 0 0 0.25rem rgba(var(--bs-primary-rgb), 0.1);
        }
        .form-range {
            height: 0.5rem;
        }
        .range-value {
            text-align: center;
            font-weight: 700;
            margin-top: 0.75rem;
            font-size: 1.1rem;
        }
        .tos-text {
            font-size: 0.875rem;
            margin-top: 1rem;
            text-align: center;
        }
        textarea.form-control {
            resize: vertical;
            min-height: 100px;
        }
        small.text-muted {
            font-size: 0.875rem;
            color: #6c757d;
        }
        .success-message {
            text-align: center;
            padding: 3rem;
        }
        .success-message i {
            font-size: 5rem;
            margin-bottom: 1.5rem;
        }
        .success-message h2 {
            margin-bottom: 1rem;
        }
        .success-message .alert {
            border-radius: 0.75rem;
            background-color: #215c5c;
            color: #fff;
        }
        hr {
            margin: 2.5rem 0;
            opacity: 0.1;
        }
    </style>
    <main>
        <section class="section">
            <div class="container">
                <div class="row">
                    <div class="col-lg-8">
                        <div class="form-container">
                            <div class="text-center mb-5" id="form-header">
                                <span class="subtitle">Get Started</span>
                                <h2 class="mb-4">Get Your Free Home Cleaning Estimate</h2>
                                <h5 class="text-muted fw-normal mb-4">Fill out your details below - Please note, we book at least two weeks in advance!</h5>
                                <p class="text-muted">We can't wait to help you get your time back! First, we'll get a bit of information about your
                                    home so we can best estimate the time it will take to clean it properly. Please fill out the form below and we will be
                                    in contact within 24 hours to go over the estimated time and price to get your home sparkling clean. A lot of times our
                                    estimates can go to spam or junk so make sure to check there if you are not seeing it within 24 hours.</p>
                            </div>
                            <hr>
                            <form id="cleaningEstimateForm" novalidate>
                                <div class="row g-3 mb-4">
                                    <div class="col-md-6">
                                        <label for="firstName" class="form-label">First Name
                                            <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" id="firstName" name="firstName" required placeholder="Enter your first name">
                                        <div class="invalid-feedback">Please enter your first name.</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="lastName" class="form-label">Last Name
                                            <span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" id="lastName" name="lastName" required placeholder="Enter your last name">
                                        <div class="invalid-feedback">Please enter your last name.</div>
                                    </div>
                                </div>
                                <div class="row g-3 mb-4">
                                    <div class="col-md-6">
                                        <label for="email" class="form-label">Email
                                            <span class="text-danger">*</span>
                                        </label>
                                        <input type="email" class="form-control" id="email" name="email" required placeholder="Enter your email">
                                        <div class="invalid-feedback">Please enter a valid email.</div>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="phone" class="form-label">Phone Number</label>
                                        <input
                                            type="tel"
                                            class="form-control"
                                            id="phone"
                                            name="phone"
                                            placeholder="Enter your phone number"
                                            pattern="[0-9\s\-\(\)\+\.]{10,20}">
                                        <div class="invalid-feedback">Please enter a valid phone number.</div>
                                    </div>
                                    <div class="form-check mb-4 col-md-12">
                                        <input class="form-check-input" type="checkbox" id="smsConsent" name="smsConsent">
                                        <label class="form-check-label" for="smsConsent">
                                            I consent to receive SMS related to this booking
                                            <span class="text-danger">*</span>
                                        </label>
                                    </div>
                                </div>
                                <!-- Service Address -->
                                <h3 class="form-section-title">Service Address</h3>
                                <div class="mb-4">
                                    <label for="address1" class="form-label">Address Line 1</label>
                                    <input type="text" class="form-control" id="address1" name="address1" placeholder="Street address">
                                </div>
                                <div class="mb-4">
                                    <label for="address2" class="form-label">Address Line 2</label>
                                    <input type="text" class="form-control" id="address2" name="address2" placeholder="Apt, suite, unit, etc. (optional)">
                                </div>
                                <div class="row g-3 mb-4">
                                    <div class="col-md-5">
                                        <label for="city" class="form-label">City / Town</label>
                                        <input type="text" class="form-control" id="city" name="city" placeholder="City">
                                    </div>
                                    <div class="col-md-3">
                                        <label for="state" class="form-label">State / Region</label>
                                        <input type="text" class="form-control" id="state" name="state" placeholder="State">
                                    </div>
                                    <div class="col-md-4">
                                        <label for="zipcode" class="form-label">ZIP / Postal Code</label>
                                        <input type="text" class="form-control" id="zipcode" name="zipcode" placeholder="ZIP code">
                                    </div>
                                </div>
                                <!-- Property Details -->
                                <h3 class="form-section-title">Property Details</h3>
                                <div class="mb-4">
                                    <label for="bedrooms" class="form-label d-flex align-items-center gap-2">
                                        <i class="bi bi-door-closed"></i>
                                        How many bedrooms should be cleaned?
                                    </label>
                                    <input type="range" class="form-range" id="bedrooms" name="bedrooms" min="0" max="6" value="1" step="1">
                                    <div class="range-value" id="bedroomsValue">1 Bedroom</div>
                                </div>
                                <div class="mb-4">
                                    <label for="bathrooms" class="form-label d-flex align-items-center gap-2">
                                        <i class="bi bi-droplet"></i>
                                        How many bathrooms should be cleaned?
                                    </label>
                                    <input type="range" class="form-range" id="bathrooms" name="bathrooms" min="0" max="6" value="1" step="1">
                                    <div class="range-value" id="bathroomsValue">1 Bathroom</div>
                                    <small class="text-muted d-block mt-2">Count bathrooms with only a toilet and sink as a half bathroom</small>
                                </div>
                                <div class="mb-4">
                                    <label for="sqft" class="form-label d-flex align-items-center gap-2">
                                        <i class="bi bi-arrows-angle-expand"></i>
                                        How large is the property?
                                    </label>
                                    <input type="range" class="form-range" id="sqft" name="sqft" min="300" max="10000" value="1200" step="100">
                                    <div class="range-value" id="sqftValue">About 1,200 sqft</div>
                                </div>
                                <!-- Cleaning Schedule -->
                                <div class="mb-4">
                                    <label class="form-label">Choose your cleaning schedule</label>
                                    <div class="row g-2">
                                        <div class="col-6 col-md-3">
                                            <input type="radio" class="btn-check" name="schedule" id="oneTime" value="One-time" autocomplete="off" checked>
                                            <label class="btn w-100" for="oneTime">One Time</label>
                                        </div>
                                        <div class="col-6 col-md-3">
                                            <input type="radio" class="btn-check" name="schedule" id="weekly" value="Weekly" autocomplete="off">
                                            <label class="btn w-100" for="weekly">Weekly</label>
                                        </div>
                                        <div class="col-6 col-md-3">
                                            <input type="radio" class="btn-check" name="schedule" id="biweekly" value="Bi-weekly" autocomplete="off">
                                            <label class="btn w-100" for="biweekly">Every 2 Weeks</label>
                                        </div>
                                        <div class="col-6 col-md-3">
                                            <input type="radio" class="btn-check" name="schedule" id="monthly" value="Monthly" autocomplete="off">
                                            <label class="btn w-100" for="monthly">Monthly</label>
                                        </div>
                                    </div>
                                </div>
                                <!-- Last Professional Clean -->
                                <div class="mb-4">
                                    <label class="form-label">When was the property last professionally cleaned?</label>
                                    <div class="row g-2">
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="lastClean" id="fewDays" value="A few days ago">
                                                <label class="form-check-label" for="fewDays">A few days ago</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="lastClean" id="month" value="Less than a month ago">
                                                <label class="form-check-label" for="month">Less than a month ago</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="lastClean" id="threeMonths" value="Less than 3 months ago">
                                                <label class="form-check-label" for="threeMonths">Less than 3 months ago</label>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="lastClean" id="sixMonths" value="Less than 6 months ago">
                                                <label class="form-check-label" for="sixMonths">Less than 6 months ago</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="radio" name="lastClean" id="never" value="More than 6 months ago or never">
                                                <label class="form-check-label" for="never">More than 6 months ago or never</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- Additional Questions -->
                                <h3 class="form-section-title">Additional Information</h3>
                                <div class="mb-4">
                                    <label for="smokePests" class="form-label">
                                        Has the home been smoked in or are there any known issues with pests or mold?
                                        <span class="text-danger">*</span>
                                    </label>
                                    <small class="d-block text-muted mb-2">We do not clean homes that are smoked in, that have smoke damage/residue, have
                                        active infestations, or mold.</small>
                                    <textarea class="form-control" id="smokePests" name="smokePests" rows="3"></textarea>
                                </div>
                                <div class="mb-4">
                                    <label for="vacant" class="form-label">
                                        Is this home vacant? Do you have a move-in/move-out date?
                                    </label>
                                    <small class="d-block text-muted mb-2">(All furnishings and personal belongings removed)</small>
                                    <textarea class="form-control" id="vacant" name="vacant" rows="3"></textarea>
                                </div>
                                <div class="mb-4">
                                    <label for="timeline" class="form-label">
                                        How soon would you like your first cleaning?
                                    </label>
                                    <small class="d-block text-muted mb-2">List any specific dates or preferred days. Please note, we book at least 2 weeks
                                        in advance unless cancellations occur.</small>
                                    <textarea class="form-control" id="timeline" name="timeline" rows="3"></textarea>
                                </div>
                                <div class="mb-4">
                                    <label for="homeLayout" class="form-label">
                                        Home layout details
                                    </label>
                                    <small class="d-block text-muted mb-2">Is your home: single story, split-level, 2 levels, 3 levels? Do you have a
                                        finished basement?</small>
                                    <textarea class="form-control" id="homeLayout" name="homeLayout" rows="2"></textarea>
                                </div>
                                <div class="mb-4">
                                    <label for="decorStyle" class="form-label">
                                        What is your decorating style?
                                    </label>
                                    <small class="d-block text-muted mb-2">Minimalist or more of a collector?</small>
                                    <textarea class="form-control" id="decorStyle" name="decorStyle" rows="2"></textarea>
                                </div>
                                <div class="mb-4">
                                    <label for="priorities" class="form-label">
                                        What areas bring you the most stress?
                                    </label>
                                    <small class="d-block text-muted mb-2">What rooms are your top priorities for cleaning?</small>
                                    <textarea class="form-control" id="priorities" name="priorities" rows="3"></textarea>
                                </div>
                                <div class="mb-4">
                                    <label for="skipRooms" class="form-label">
                                        Any rooms to skip during cleaning?
                                    </label>
                                    <textarea
                                        class="form-control"
                                        id="skipRooms"
                                        name="skipRooms"
                                        rows="2"
                                        placeholder="List any rooms that should be skipped"></textarea>
                                </div>
                                <div class="mb-4">
                                    <label for="otherDetails" class="form-label">
                                        Any other details about your home?
                                    </label>
                                    <small class="d-block text-muted mb-2">Number of pets, number of kids, scent sensitivities, etc.</small>
                                    <textarea class="form-control" id="otherDetails" name="otherDetails" rows="3"></textarea>
                                </div>
                                <div class="mb-4">
                                    <label for="previousService" class="form-label">
                                        Previous cleaning service experience
                                    </label>
                                    <small class="d-block text-muted mb-2">Have you used a professional cleaning service previously? Were you dissatisfied?</small>
                                    <textarea class="form-control" id="previousService" name="previousService" rows="3"></textarea>
                                </div>
                                <div class="mb-4">
                                    <label for="referral" class="form-label">
                                        How did you hear about us?
                                    </label>
                                    <small class="d-block text-muted mb-2">(Web Search, Word of Mouth/Referral, Facebook, Vehicle or Office Signage)</small>
                                    <textarea class="form-control" id="referral" name="referral" rows="2"></textarea>
                                </div>
                                <!-- Submit Button -->
                                <div class="text-center mt-5">
                                    <button type="submit" class="btn">
                                        Submit Estimate Request
                                    </button>
                                    <p class="tos-text">
                                        By clicking "Submit Estimate Request" you agree to our Terms of Service
                                    </p>
                                </div>
                            </form>
                            <!-- Success Message (hidden by default) -->
                            <div id="successMessage" class="success-message" style="display: none;">
                                <i class="bi bi-check-circle-fill"></i>
                                <h2>Estimate request successfully sent!</h2>
                                <p class="lead mb-4">
                                    Thank you for submitting a request for your FREE cleaning estimate! We will be in contact shortly to discuss your
                                    estimate.
                                </p>
                                <div class="alert alert-warning mb-0">
                                    <strong>IMPORTANT:</strong>
                                    Check your spam folders in the next 24 hours for our estimate so you don't miss it!
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Sidebar -->
                    <div class="col-lg-4 d-none d-lg-block">
                        <div class="sidebar-element">
                            <i class="bi bi-house-door"></i>
                            <strong>Request a Quote</strong>
                            <p>Take 60 seconds to tell us about yourself and your home.</p>
                        </div>
                        <div class="sidebar-element">
                            <i class="bi bi-calendar-check"></i>
                            <strong>Confirm Your Appointment</strong>
                            <p>Minty Clean will contact you by email with your estimate information.</p>
                        </div>
                        <div class="sidebar-element">
                            <i class="bi bi-sun"></i>
                            <strong>Relax & Let Us Clean!</strong>
                            <p>We're excited to take care of the cleaning, giving you time to focus on what's most important.</p>
                        </div>
                        <div class="summary-box">
                            <h3>Your Cleaning Summary</h3>
                            <div id="summary-content">
                                <p class="text-muted mb-0">Fill out the form to see your cleaning details</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
        <footer class="footer pt-5 pb-5">
            <div class="container">
                <div class="row justify-content-between mb-5 g-xl-5">
                    <div class="col-md-4 mb-5 mb-lg-0">
                        <img class="logo light img-fluid" src="/assets/images/minty_logo.png" alt="Minty Clean" width="100">
                        <p class="mb-4">Local, loud, and proud â€” we keep Tucson homes sparkling so you can actually enjoy living in them.</p>
                    </div>
                    <div class="col-md-7">
                        <div class="row g-2">
                            <div class="col-md-6 col-lg-4 mb-4 mb-lg-0">
                                <h3 class="mb-4">Company</h3>
                                <ul class="list-unstyled">
                                    <li>
                                        <a href="index.html#about">About</a>
                                    </li>
                                    <li>
                                        <a href="/careers">Careers
                                            <span class="badge ms-1">we're hiring</span>
                                        </a>
                                    </li>
                                    <li>
                                        <a href="index.html#services">Services</a>
                                    </li>
                                </ul>
                            </div>
                            <div class="col-md-6 col-lg-4 mb-4 mb-lg-0 quick-contact">
                                <h3 class="mb-4">Contact</h3>
                                <p class="d-flex mb-4">
                                    <i class="bi bi-geo-alt-fill me-3"></i>
                                    <span>Tucson, AZ</span>
                                </p>
                                <a class="d-flex mb-4" href="mailto:hello@callminty.com">
                                    <i class="bi bi-envelope-fill me-3"></i>
                                    <span>hello@callminty.com</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row credits pt-3">
                    <div class="col-xl-8 text-center text-xl-start mb-4 mb-xl-0">
                        &copy;
                        <script>
                            document.write(new Date().getFullYear());
                        </script>
                        Minty Clean. All rights reserved.
                    </div>
                </div>
            </div>
        </footer>
    </main>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        (function () {
            const form = document.getElementById('cleaningEstimateForm');
            const successMessage = document.getElementById('successMessage');
            const submitButton = form.querySelector('button[type="submit"]');
            const formHeader = document.getElementById('form-header');
            const hrElement = document.querySelector('hr');
            const n8nWebhookUrl = 'https://n8n.supergoodsystems.com/webhook/minty-quote-request';
            // Range slider updates with summary integration
            const bedrooms = document.getElementById('bedrooms');
            const bedroomsValue = document.getElementById('bedroomsValue');
            bedrooms.addEventListener('input', function () {
                const val = this.value;
                bedroomsValue.textContent = val == 0
                    ? 'No Bedrooms'
                    : val == 1
                        ? '1 Bedroom'
                        : val == 6
                            ? '6+ Bedrooms'
                            : val + ' Bedrooms';
                updateSummary();
            });
            const bathrooms = document.getElementById('bathrooms');
            const bathroomsValue = document.getElementById('bathroomsValue');
            bathrooms.addEventListener('input', function () {
                const val = this.value;
                bathroomsValue.textContent = val == 0
                    ? 'No Bathrooms'
                    : val == 1
                        ? '1 Bathroom'
                        : val == 6
                            ? '6+ Bathrooms'
                            : val + ' Bathrooms';
                updateSummary();
            });
            const sqft = document.getElementById('sqft');
            const sqftValue = document.getElementById('sqftValue');
            sqft.addEventListener('input', function () {
                const val = parseInt(this.value);
                sqftValue.textContent = 'About ' + val.toLocaleString() + ' sqft';
                updateSummary();
            });
            // Update summary sidebar
            function updateSummary() {
                const b = bedrooms.value;
                const ba = bathrooms.value;
                const s = sqft.value;
                const summaryContent = document.getElementById('summary-content');
                summaryContent.innerHTML = `
            <div class="d-flex align-items-start gap-3 mb-4">
                <i class="bi bi-house-check" style="font-size: 1.5rem;"></i>
                <div>
                    <strong class="d-block">${b} Bedroom${
                    b != 1
                        ? 's'
                        : ''
                    }, ${ba} Bathroom${
                    ba != 1
                        ? 's'
                        : ''
                    }</strong>
                    <small class="text-muted">${
                    parseInt(s).toLocaleString()
                } Square Feet</small>
                </div>
            </div>
        `;
            }
            // Capture UTM parameters from URL
            function captureUTMData() {
                const urlParams = new URLSearchParams(window.location.search);
                const utmData = {};
                // Capture standard UTM parameters
                const utmParams = [
                    'utm_source',
                    'utm_medium',
                    'utm_campaign',
                    'utm_term',
                    'utm_content'
                ];
                utmParams.forEach(param => {
                    const value = urlParams.get(param);
                    if (value) {
                        utmData[param] = value;
                    }
                });
                // Capture referrer
                if (document.referrer) {
                    utmData.referrer = document.referrer;
                }
                // Capture landing page
                utmData.landing_page = window.location.href;
                return utmData;
            }
            // Collect form data
            function collectFormData() {
                const formData = new FormData(form);
                const data = {};
                // Collect all form fields
                for (let [key, value] of formData.entries()) {
                    data[key] = value;
                }
                // Add range values explicitly
                data.bedrooms = bedrooms.value;
                data.bathrooms = bathrooms.value;
                data.sqft = sqft.value;
                // Add checkbox value
                data.smsConsent = document.getElementById('smsConsent').checked;
                // Add UTM data
                data.utm = captureUTMData();
                // Add timestamp
                data.submittedAt = new Date().toISOString();
                return data;
            }
            // Helper function to validate a single field
            function validateField(fieldId, validator) {
                const field = document.getElementById(fieldId);
                const isFieldValid = validator(field);
                field.classList.toggle('is-invalid', ! isFieldValid);
                return isFieldValid;
            }
            // Validate form
            function validateForm() {
                const validations = [
                    // First name validation
                    validateField('firstName', field => field.value.trim() !== ''),
                    // Last name validation
                    validateField('lastName', field => field.value.trim() !== ''),
                    // Email validation
                    validateField('email', field => {
                        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                        return field.value.trim() && emailRegex.test(field.value);
                    }),
                    // Phone validation (optional field)
                    validateField('phone', field => {
                        if (!field.value.trim()) 
                            return true;
                        
                        // Optional field
                        const phoneRegex = /[0-9\s\-\(\)\+\.]{10,20}/;
                        return phoneRegex.test(field.value);
                    })
                ];
                return validations.every(valid => valid);
            }
            // Submit form to n8n
            async function submitToN8n(data) {
                try {
                    const response = await fetch(n8nWebhookUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });
                    if (! response.ok) {
                        throw new Error (`HTTP error! status: ${
                            response.status
                        }`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error('Error submitting to n8n:', error);
                    throw error;
                }
            }
            // Handle form submission
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                // Validate form
                if (! validateForm()) {
                    return;
                }
                // Disable submit button
                submitButton.disabled = true;
                submitButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Sending...';
                try { // Collect and submit data
                    const formData = collectFormData();
                    await submitToN8n(formData);
                    // Hide form elements and show success message
                    formHeader.style.display = 'none';
                    hrElement.style.display = 'none';
                    form.style.display = 'none';
                    successMessage.style.display = 'block';
                    // Scroll to top of page
                    window.scrollTo({top: 0, behavior: 'smooth'});
                } catch (error) {
                    alert('There was an error submitting your request. Please try again or contact us directly.');
                    console.error('Submission error:', error);
                    // Re-enable submit button
                    submitButton.disabled = false;
                    submitButton.textContent = 'Submit Estimate Request';
                }
            });
            // Real-time validation on input
            const inputs = form.querySelectorAll('input[required], input[type="email"]');
            inputs.forEach(input => {
                input.addEventListener('blur', validateForm);
                input.addEventListener('input', () => {
                    if (input.classList.contains('is-invalid')) {
                        validateForm();
                    }
                });
            });
            // Initialize summary on page load
            updateSummary();
        })();
    </script>
{% endblock %}